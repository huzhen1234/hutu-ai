import{u as E,r as t,B as K,h as O,c as g,o as d,a as e,k as P,l as B,v as I,i as S,j as q,n as w,e as R,C as L,t as k,F as X,d as J,m as Q,p as W,q as V,f as Y}from"./index-yHA_Ioyc.js";import{r as Z,c as ee,C as se}from"./api-CNdQDF4x.js";import{_ as ae}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as te}from"./HeartIcon-CY9p_lZI.js";const le={class:"game-container"},oe={key:0,class:"game-start"},ne={class:"input-area"},re={key:1,class:"chat-main"},ue={class:"game-stats"},ie={class:"stat-item"},ce={class:"label"},ve={class:"progress-bar"},de={class:"value"},me={class:"stat-item"},fe={class:"value"},pe={class:"input-area"},ge=["disabled"],he=["disabled"],_e={class:"result"},y=10,we={__name:"GameChat",setup(ke){const F=E(),h=t(null),G=t(null),u=t(""),m=t(!1),N=t(null),n=t([]),f=t(""),b=t(!1),r=t(!1),i=t(""),c=t(0),a=t(0),T=()=>{const l=G.value;l&&(l.style.height="auto",l.style.height=l.scrollHeight+"px")},M=async()=>{await V(),h.value&&(h.value.scrollTop=h.value.scrollHeight)},H=async()=>{b.value=!0,r.value=!1,i.value="",N.value=Date.now().toString(),n.value=[],c.value=0,a.value=0;const l=f.value?`开始游戏，女友生气原因：${f.value}`:"开始游戏";await x(l)},U=()=>{b.value=!1,r.value=!1,i.value="",n.value=[],f.value="",u.value="",c.value=0,a.value=0},x=async l=>{if(m.value||!l&&!u.value.trim())return;const s=l||u.value.trim(),o={role:"user",content:s,timestamp:new Date};n.value.push(o),l||(u.value="",T(),c.value++),await M();const v={role:"assistant",content:"",timestamp:new Date};n.value.push(v),m.value=!0;let p="";try{const C=await ee.sendGameMessage(s,N.value),j=new TextDecoder("utf-8");for(;;)try{const{value:D,done:z}=await C.read();if(z)break;p+=j.decode(D);const $=p.match(/原谅值[:：]\s*(\d+)/i);if($){const _=parseInt($[1]);isNaN(_)||(a.value=Math.min(100,Math.max(0,_)),a.value>=100&&(r.value=!0,i.value="恭喜你！成功哄好了女友！💕"))}await V(()=>{const _={...v,content:p},A=n.value.length-1;n.value.splice(A,1,_)}),await M()}catch(D){console.error("读取流错误:",D);break}c.value>=y?(r.value=!0,a.value>=100?i.value="恭喜你！在最后一轮成功哄好了女友！💕":i.value=`游戏结束：对话轮次已达上限(${y}轮)，当前原谅值为${a.value}，很遗憾没能完全哄好女友`):p.includes("游戏结束")&&(r.value=!0,i.value=p)}catch(C){console.error("发送消息失败:",C),v.content="抱歉，发生了错误，请稍后重试。"}finally{m.value=!1,await M()}};return K(()=>y-c.value),O(()=>{T()}),(l,s)=>(d(),g("div",{class:w(["game-chat",{dark:R(F)}])},[e("div",le,[b.value?(d(),g("div",re,[e("div",ue,[e("div",ie,[e("span",ce,[S(R(te),{class:w(["heart-icon",{beating:a.value>=100}])},null,8,["class"]),s[5]||(s[5]=q(" 女友原谅值 "))]),e("div",ve,[e("div",{class:w(["progress",{low:a.value<30,medium:a.value>=30&&a.value<70,high:a.value>=70}]),style:L({width:`${a.value}%`})},null,6)]),e("span",de,k(a.value)+"%",1)]),e("div",me,[s[6]||(s[6]=e("span",{class:"label"},"对话轮次",-1)),e("span",fe,k(c.value)+"/"+k(y),1)])]),e("div",{class:"messages",ref_key:"messagesRef",ref:h},[(d(!0),g(X,null,J(n.value,(o,v)=>(d(),Y(se,{key:v,message:o,"is-stream":m.value&&v===n.value.length-1},null,8,["message","is-stream"]))),128))],512),e("div",pe,[B(e("textarea",{"onUpdate:modelValue":s[1]||(s[1]=o=>u.value=o),onKeydown:s[2]||(s[2]=Q(W(o=>x(),["prevent"]),["enter"])),placeholder:"输入消息...",rows:"1",ref_key:"inputRef",ref:G,disabled:r.value},null,40,ge),[[I,u.value]]),e("button",{class:"send-button",onClick:s[3]||(s[3]=o=>x()),disabled:m.value||!u.value.trim()||r.value},[S(R(Z),{class:"icon"})],8,he)])])):(d(),g("div",oe,[s[4]||(s[4]=e("h2",null,"哄哄模拟器",-1)),e("div",ne,[B(e("textarea",{"onUpdate:modelValue":s[0]||(s[0]=o=>f.value=o),placeholder:"请输入女友生气的原因（可选）...",rows:"3"},null,512),[[I,f.value]]),e("button",{class:"start-button",onClick:H}," 开始游戏 ")])])),r.value?(d(),g("div",{key:2,class:w(["game-over",{success:a.value>=100}])},[e("div",_e,k(i.value),1),e("button",{class:"restart-button",onClick:U}," 重新开始 ")],2)):P("",!0)])],2))}},Ce=ae(we,[["__scopeId","data-v-d15d35da"]]);export{Ce as default};
