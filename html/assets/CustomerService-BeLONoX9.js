import{u as j,r as n,s as H,h as E,c as v,o as c,a as t,k as F,i as g,j as K,e as m,F as $,d as S,l as q,v as G,m as O,p as P,n as B,q as I,x as U,t as J,f as Q}from"./index-yHA_Ioyc.js";import{a as W,r as X,c as M,C as Y}from"./api-CNdQDF4x.js";import{_ as Z}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as ee}from"./PlusIcon-Bv4rmf3g.js";import{r as se}from"./ChatBubbleLeftRightIcon-BXHQdny5.js";const te={class:"chat-container"},ae={class:"sidebar"},oe={class:"history-header"},ne={class:"history-list"},re=["onClick"],ie={class:"title"},le={class:"chat-main"},ce={class:"service-header"},ue={class:"service-info"},de={class:"input-area"},ve=["disabled"],me={key:0,class:"booking-modal"},he={class:"modal-content"},fe=["innerHTML"],pe={__name:"CustomerService",setup(ge){const A=j(),h=n(null),b=n(null),i=n(""),u=n(!1),f=n(null),o=n([]),d=n([]),w=n(!1),x=n("");H.setOptions({breaks:!0,gfm:!0,sanitize:!1});const D=()=>{const s=b.value;s&&(s.style.height="auto",s.style.height=s.scrollHeight+"px")},k=async()=>{await I(),h.value&&(h.value.scrollTop=h.value.scrollHeight)},_=async s=>{if(u.value||!s&&!i.value.trim())return;const e=s||i.value.trim(),a={role:"user",content:e,timestamp:new Date};o.value.push(a),s||(i.value="",D()),await k();const r={role:"assistant",content:"",timestamp:new Date,isMarkdown:!0};o.value.push(r),u.value=!0;let p="";try{const C=await M.sendServiceMessage(e,f.value),R=new TextDecoder("utf-8");for(;;)try{const{value:l,done:V}=await C.read();if(V)break;p+=R.decode(l),await I(()=>{const z={...r,content:p,isMarkdown:!0},L=o.value.length-1;o.value.splice(L,1,z)}),await k()}catch(l){console.error("读取流错误:",l);break}if(p.includes("预约编号")){const l=p.match(/【(.*?)】/s);l&&(x.value=U.sanitize(H.parse(l[1]),{ADD_TAGS:["code","pre","span"],ADD_ATTR:["class","language"]}),w.value=!0)}}catch(C){console.error("发送消息失败:",C),r.content="抱歉，发生了错误，请稍后重试。"}finally{u.value=!1,await k()}},T=async s=>{f.value=s;try{const e=await M.getChatMessages(s,"service");o.value=e.map(a=>({...a,isMarkdown:a.role==="assistant"}))}catch(e){console.error("加载对话消息失败:",e),o.value=[]}},N=async()=>{try{const s=await M.getChatHistory("service");d.value=s||[],s&&s.length>0?await T(s[0].id):await y()}catch(s){console.error("加载聊天历史失败:",s),d.value=[],await y()}},y=async()=>{const s=Date.now().toString();f.value=s,o.value=[];const e={id:s,title:`咨询 ${s.slice(-6)}`};d.value=[e,...d.value],await _("你好")};return E(()=>{N(),D()}),(s,e)=>(c(),v("div",{class:B(["customer-service",{dark:m(A)}])},[t("div",te,[t("div",ae,[t("div",oe,[e[5]||(e[5]=t("h2",null,"咨询记录",-1)),t("button",{class:"new-chat",onClick:y},[g(m(ee),{class:"icon"}),e[4]||(e[4]=K(" 新咨询 "))])]),t("div",ne,[(c(!0),v($,null,S(d.value,a=>(c(),v("div",{key:a.id,class:B(["history-item",{active:f.value===a.id}]),onClick:r=>T(a.id)},[g(m(se),{class:"icon"}),t("span",ie,J(a.title||"新咨询"),1)],10,re))),128))])]),t("div",le,[t("div",ce,[t("div",ue,[g(m(W),{class:"avatar"}),e[6]||(e[6]=t("div",{class:"info"},[t("h3",null,"小黑"),t("p",null,"黑马程序员智能客服")],-1))])]),t("div",{class:"messages",ref_key:"messagesRef",ref:h},[(c(!0),v($,null,S(o.value,(a,r)=>(c(),Q(Y,{key:r,message:a,"is-stream":u.value&&r===o.value.length-1},null,8,["message","is-stream"]))),128))],512),t("div",de,[q(t("textarea",{"onUpdate:modelValue":e[0]||(e[0]=a=>i.value=a),onKeydown:e[1]||(e[1]=O(P(a=>_(),["prevent"]),["enter"])),placeholder:"请输入您的问题...",rows:"1",ref_key:"inputRef",ref:b},null,544),[[G,i.value]]),t("button",{class:"send-button",onClick:e[2]||(e[2]=a=>_()),disabled:u.value||!i.value.trim()},[g(m(X),{class:"icon"})],8,ve)])])]),w.value?(c(),v("div",me,[t("div",he,[e[7]||(e[7]=t("h3",null,"预约成功！",-1)),t("div",{class:"booking-info",innerHTML:x.value},null,8,fe),t("button",{onClick:e[3]||(e[3]=a=>w.value=!1)},"确定")])])):F("",!0)],2))}},Me=Z(pe,[["__scopeId","data-v-ba83f554"]]);export{Me as default};
