import{c as m,o as p,a,u as K,r as c,h as Z,y as A,z as G,i as y,e as k,t as B,k as oe,A as ne,s as re,j as L,F as j,d as z,p as U,n as I,l as ie,v as ue,m as ce,q,f as de}from"./index-yHA_Ioyc.js";import{r as ve,c as H,C as fe}from"./api-CNdQDF4x.js";import{_ as J}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as E}from"./DocumentTextIcon-BwMQLpu3.js";import{r as pe}from"./PlusIcon-Bv4rmf3g.js";function he(P,b){return p(),m("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5"})])}function me(P,b){return p(),m("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m6.75 12-3-3m0 0-3 3m3-3v6m-1.5-15H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z"})])}const ge={class:"pdf-view"},we={class:"pdf-header"},ye={class:"filename"},ke={class:"pdf-content"},De={key:0,class:"pdf-loading"},_e={__name:"PDFViewer",props:{file:{type:[File,null],default:null},fileName:{type:String,default:""}},setup(P){const b=K(),x=P,d=c(!1),u=c(null);let n=null;Z(async()=>{if(u.value&&x.file)try{d.value=!0;const o=document.createElement("iframe");o.style.width="100%",o.style.height="100%",o.style.border="none";const l=URL.createObjectURL(x.file);o.src=l,u.value.innerHTML="",u.value.appendChild(o),o.onload=()=>{d.value=!1},n={url:l}}catch(o){console.error("PDF 查看器初始化失败:",o),d.value=!1}});const w=o=>{const l=document.createElement("iframe");l.style.width="100%",l.style.height="100%",l.style.border="none";const r=URL.createObjectURL(o);return b.value?l.style.backgroundColor="#1a1a1a":l.style.backgroundColor="#ffffff",l.src=r,{iframe:l,url:r}};return A(()=>x.file,o=>{if(o){n!=null&&n.url&&URL.revokeObjectURL(n.url);try{d.value=!0;const{iframe:l,url:r}=w(o);u.value&&(u.value.innerHTML="",u.value.appendChild(l)),l.onload=()=>{d.value=!1},n={url:r,iframe:l}}catch(l){console.error("加载 PDF 失败:",l),d.value=!1}}}),A(()=>b.value,o=>{n!=null&&n.iframe&&(o?n.iframe.style.backgroundColor="#1a1a1a":n.iframe.style.backgroundColor="#ffffff")}),G(()=>{n!=null&&n.url&&URL.revokeObjectURL(n.url)}),(o,l)=>(p(),m("div",ge,[a("div",we,[y(k(E),{class:"icon"}),a("span",ye,B(P.fileName),1)]),a("div",ke,[d.value?(p(),m("div",De,l[0]||(l[0]=[a("div",{class:"loading-spinner"},null,-1),a("p",{class:"loading-text"},"正在加载 PDF...",-1)]))):oe("",!0),a("div",{class:"pdf-container",ref_key:"viewerRef",ref:u},null,512)])]))}},Ce=J(_e,[["__scopeId","data-v-4d27e483"]]),be={class:"chat-container"},Fe={class:"sidebar"},$e={class:"sidebar-header"},Pe={class:"history-list"},xe={class:"history-header"},Me=["onClick"],Re={class:"title"},Le={class:"chat-main"},Ue={key:0,class:"upload-welcome"},Ie={class:"upload-content"},Te={key:0,class:"upload-status"},Ne={class:"upload-progress"},je={class:"filename"},He=["disabled"],Ve={key:1,class:"split-view"},Be={class:"chat-view"},Ee={class:"input-area"},Oe=["disabled"],V="http://localhost:8080",Se={__name:"ChatPDF",setup(P){const b=K(),x=ne(),d=c(null),u=c(null),n=c(""),w=c(!1),o=c(!1),l=c(null),r=c([]),g=c([]),D=c(""),M=c(!1);re.setOptions({breaks:!0,gfm:!0,sanitize:!1});const Q=()=>{const t=u.value;t&&(t.style.height="auto",t.style.height=t.scrollHeight+"px")},T=async()=>{await q(),d.value&&(d.value.scrollTop=d.value.scrollHeight)},N=c(!1),F=c(null),R=()=>{D.value="",r.value=[],F.value=null,l.value=null,N.value=!1,o.value=!1,_.value="",n.value="",w.value=!1,u.value&&(u.value.style.height="auto")},W=t=>{t.preventDefault(),R(),x.push("/")},X=()=>{try{R(),F.value=null,D.value="",l.value=null,r.value=[],o.value=!1,_.value="",n.value="",u.value&&(u.value.style.height="auto"),d.value&&(d.value.scrollTop=0)}catch(t){console.error("开始新对话失败:",t)}},O=async t=>{if(t){R(),l.value=t;try{const s=await H.getChatMessages(t,"pdf");r.value=s.map(v=>({...v,isMarkdown:v.role==="assistant"})),N.value=!0;const e=await fetch(`${V}/ai/pdf/file/${t}`);if(!e.ok)throw new Error("获取 PDF 失败");const i=e.headers.get("content-disposition");let h="document.pdf";if(i){const v=i.match(/filename=["']?([^"']+)["']?/);v&&v[1]&&(h=decodeURIComponent(v[1]))}D.value=h;const f=g.value.findIndex(v=>v.id===t);f!==-1&&(g.value[f].title=h);const C=await e.blob();F.value=new File([C],h,{type:"application/pdf"})}catch(s){console.error("加载失败:",s);const e={role:"assistant",content:"加载失败，请重试。",timestamp:new Date,isMarkdown:!0};r.value.push(e)}finally{N.value=!1}}},Y=async()=>{try{const t=await H.getChatHistory("pdf");g.value=t||[],t&&t.length>0&&await O(t[0].id)}catch(t){console.error("加载聊天历史失败:",t),g.value=[]}},ee=async t=>{t.preventDefault(),M.value=!1;const s=t.dataTransfer.files;if(s.length===0)return;const e=s[0];if(e.type!=="application/pdf"){alert("请上传 PDF 文件");return}o.value=!0,_.value=e.name;try{const i=new FormData;i.append("file",e);const h=l.value||`pdf_${Date.now()}`,f=await fetch(`${V}/ai/pdf/upload/${h}`,{method:"POST",body:i});if(!f.ok)throw new Error(`上传失败: ${f.status}`);const C=await f.json();l.value=C.chatId||h,D.value=e.name,F.value=e;const v={id:l.value,title:`PDF对话: ${e.name.slice(0,20)}${e.name.length>20?"...":""}`};g.value.some($=>$.id===l.value)||(g.value=[v,...g.value]),r.value=[],r.value.push({role:"assistant",content:`已上传 PDF 文件: ${e.name}。您可以开始提问了。`,timestamp:new Date,isMarkdown:!0})}catch(i){console.error("上传失败:",i),alert("文件上传失败，请重试")}finally{o.value=!1,_.value=""}},te=t=>{t.preventDefault(),M.value=!0},ae=t=>{t.preventDefault(),M.value=!1},se=()=>{document.querySelector(".file-input").click()},_=c(""),S=async()=>{if(!n.value.trim()||w.value)return;const t={role:"user",content:n.value,timestamp:new Date};r.value.push(t);const s=n.value;n.value="",u.value&&(u.value.style.height="auto"),await T();const e=r.value.length;r.value.push({role:"assistant",content:"",timestamp:new Date,isMarkdown:!0});try{w.value=!0;const i=await H.sendPdfMessage(s,l.value),h=new TextDecoder;let f="";for(;;){const{done:C,value:v}=await i.read();if(C)break;const $=h.decode(v,{stream:!0});console.log("收到流式响应块:",$),f+=$,r.value[e]={role:"assistant",content:f,timestamp:new Date,isMarkdown:!0},await q(),await T()}}catch(i){console.error("发送消息失败:",i),r.value[e]={role:"assistant",content:"发送消息失败，请重试。",timestamp:new Date,isMarkdown:!0}}finally{w.value=!1,await T()}},le=async t=>{const s=t.target.files;if(s.length===0)return;const e=s[0];if(e.type!=="application/pdf"){alert("请上传 PDF 文件");return}o.value=!0,_.value=e.name;try{const i=new FormData;i.append("file",e);const h=l.value||`pdf_${Date.now()}`,f=await fetch(`${V}/ai/pdf/upload/${h}`,{method:"POST",body:i});if(!f.ok)throw new Error(`上传失败: ${f.status}`);const C=await f.json();l.value=C.chatId||h,D.value=e.name,F.value=e;const v={id:l.value,title:`PDF对话: ${e.name.slice(0,20)}${e.name.length>20?"...":""}`};g.value.some($=>$.id===l.value)||(g.value=[v,...g.value]),r.value=[],r.value.push({role:"assistant",content:`已上传 PDF 文件: ${e.name}。您可以开始提问了。`,timestamp:new Date,isMarkdown:!0})}catch(i){console.error("上传失败:",i),alert("文件上传失败，请重试")}finally{o.value=!1,_.value="",t.target.value=""}};return Z(()=>{Y(),Q()}),G(()=>{window.removeEventListener("cleanupChatPDF",R)}),(t,s)=>(p(),m("div",{class:I(["chat-pdf",{dark:k(b)}])},[a("div",be,[a("div",Fe,[a("div",$e,[a("a",{href:"#",class:"logo-link",onClick:W},[y(k(E),{class:"logo"}),s[3]||(s[3]=a("h1",{class:"title"},"ChatPDF",-1))])]),a("div",Pe,[a("div",xe,[s[5]||(s[5]=a("span",null,"历史记录",-1)),a("button",{class:"new-chat-btn",onClick:X},[y(k(pe),{class:"icon"}),s[4]||(s[4]=L(" 新聊天 "))])]),(p(!0),m(j,null,z(g.value,e=>(p(),m("div",{key:e.id,class:I(["history-item",{active:l.value===e.id}]),onClick:i=>O(e.id)},[y(k(E),{class:"icon"}),a("span",Re,B(e.title||"PDF对话"),1)],10,Me))),128))])]),a("div",Le,[D.value?(p(),m("div",Ve,[y(Ce,{file:F.value,fileName:D.value},null,8,["file","fileName"]),a("div",Be,[a("div",{class:"messages",ref_key:"messagesRef",ref:d},[(p(!0),m(j,null,z(r.value,(e,i)=>(p(),de(fe,{key:i,message:e,"is-stream":w.value&&i===r.value.length-1},null,8,["message","is-stream"]))),128))],512),a("div",Ee,[ie(a("textarea",{"onUpdate:modelValue":s[0]||(s[0]=e=>n.value=e),onKeydown:s[1]||(s[1]=ce(U(e=>S(),["prevent"]),["enter"])),placeholder:"请输入您的问题...",rows:"1",ref_key:"inputRef",ref:u},null,544),[[ue,n.value]]),a("button",{class:"send-button",onClick:s[2]||(s[2]=e=>S()),disabled:w.value||!n.value.trim()},[y(k(ve),{class:"icon"})],8,Oe)])])])):(p(),m("div",Ue,[s[10]||(s[10]=a("h1",{class:"main-title"},[L(" 与任何 "),a("span",{class:"highlight"},"PDF"),L(" 对话 ")],-1)),a("div",{class:I(["drop-zone",{dragging:M.value,uploading:o.value}]),onDragover:U(te,["prevent"]),onDragleave:U(ae,["prevent"]),onDrop:U(ee,["prevent"])},[a("div",Ie,[o.value?(p(),m("div",Te,[s[7]||(s[7]=a("div",{class:"spinner"},null,-1)),a("div",Ne,[s[6]||(s[6]=a("p",{class:"status-text"},"正在上传文件...",-1)),a("p",je,B(_.value),1)])])):(p(),m(j,{key:1},[y(k(me),{class:"upload-icon"}),s[9]||(s[9]=a("p",{class:"upload-text"},"点击上传，或将PDF拖拽到此处",-1)),a("input",{type:"file",accept:".pdf",onChange:le,disabled:o.value,class:"file-input"},null,40,He),a("button",{class:I(["upload-button",{uploading:o.value}]),onClick:se},[y(k(he),{class:"icon"}),s[8]||(s[8]=L(" 上传PDF "))],2)],64))])],34)]))])])],2))}},Ge=J(Se,[["__scopeId","data-v-c24fe7ea"]]);export{Ge as default};
