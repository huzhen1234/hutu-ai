import{c as i,o as n,a as s,u as Z,r as c,h as G,i as f,j as J,e as h,F as $,d as z,k as Q,l as X,v as Y,m as ee,p as te,n as j,q as H,t as b,f as ae}from"./index-yHA_Ioyc.js";import{r as se,c as B,C as oe}from"./api-CNdQDF4x.js";import{_ as re}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as ne}from"./PlusIcon-Bv4rmf3g.js";import{r as ie}from"./ChatBubbleLeftRightIcon-BXHQdny5.js";function le(C,_){return n(),i("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z"})])}function ce(C,_){return n(),i("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m18.375 12.739-7.693 7.693a4.5 4.5 0 0 1-6.364-6.364l10.94-10.94A3 3 0 1 1 19.5 7.372L8.552 18.32m.009-.01-.01.01m5.699-9.941-7.81 7.81a1.5 1.5 0 0 0 2.112 2.13"})])}function ue(C,_){return n(),i("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6 18 18 6M6 6l12 12"})])}const de={class:"chat-container"},ve={class:"sidebar"},he={class:"history-header"},me={class:"history-list"},pe=["onClick"],fe={class:"title"},ge={class:"chat-main"},_e={class:"input-area"},we={key:0,class:"selected-files"},ye={class:"file-info"},ke={class:"file-name"},xe={class:"file-size"},Ce=["onClick"],Me={class:"input-row"},De={class:"file-upload"},Fe=["disabled"],Ie=["onKeydown","placeholder"],$e=["disabled"],ze={__name:"AIChat",setup(C){const _=Z(),w=c(null),S=c(null),m=c(""),p=c(!1),y=c(null),l=c([]),g=c([]),k=c(null),r=c([]),T=()=>{const e=S.value;e?(e.style.height="auto",e.style.height=e.scrollHeight+"px"):e.style.height="50px"},M=async()=>{await H(),w.value&&(w.value.scrollTop=w.value.scrollHeight)},D={image:{maxSize:10*1024*1024,maxFiles:3,description:"图片文件"},audio:{maxSize:10*1024*1024,maxDuration:180,maxFiles:3,description:"音频文件"},video:{maxSize:150*1024*1024,maxDuration:40,maxFiles:3,description:"视频文件"}},U=()=>{var e;(e=k.value)==null||e.click()},A=async e=>{const t=e.type.split("/")[0],a=D[t];if(!a)return{valid:!1,error:"不支持的文件类型"};if(e.size>a.maxSize)return{valid:!1,error:`文件大小不能超过${a.maxSize/1024/1024}MB`};if((t==="audio"||t==="video")&&a.maxDuration)try{if(await E(e)>a.maxDuration)return{valid:!1,error:`${t==="audio"?"音频":"视频"}时长不能超过${a.maxDuration}秒`}}catch{return{valid:!1,error:"无法读取媒体文件时长"}}return{valid:!0}},E=e=>new Promise((t,a)=>{const o=e.type.startsWith("audio/")?new Audio:document.createElement("video");o.preload="metadata",o.onloadedmetadata=()=>{t(o.duration),URL.revokeObjectURL(o.src)},o.onerror=()=>{a(new Error("无法读取媒体文件")),URL.revokeObjectURL(o.src)},o.src=URL.createObjectURL(e)}),V=async e=>{const t=Array.from(e.target.files||[]);if(!t.length)return;const a=t[0].type.split("/")[0];if(t.some(d=>d.type.split("/")[0]!==a)){alert("请选择相同类型的文件（图片、音频或视频）"),e.target.value="";return}for(const d of t){const{valid:v,error:I}=await A(d);if(!v){alert(I),e.target.value="",r.value=[];return}}const u=t.reduce((d,v)=>d+v.size,0),x=D[a];if(u>x.maxSize*3){alert(`${a==="image"?"图片":a==="audio"?"音频":"视频"}文件总大小不能超过${x.maxSize*3/1024/1024}MB`),e.target.value="",r.value=[];return}r.value=t},N=()=>{if(r.value.length>0){const e=r.value[0].type.split("/")[0],t=D[e].description;return`已选择 ${r.value.length} 个${t}，可继续输入消息...`}return"输入消息，可上传图片、音频或视频..."},L=async()=>{if(p.value||!m.value.trim()&&!r.value.length)return;const e=m.value.trim(),t={role:"user",content:e,timestamp:new Date};l.value.push(t),m.value="",T(),await M();const a=new FormData;e&&a.append("prompt",e),r.value.forEach(u=>{a.append("files",u)});const o={role:"assistant",content:"",timestamp:new Date};l.value.push(o),p.value=!0;try{const u=await B.sendMessage(a,y.value),x=new TextDecoder("utf-8");let d="";for(;;)try{const{value:v,done:I}=await u.read();if(I)break;d+=x.decode(v),await H(()=>{const q={...o,content:d},W=l.value.length-1;l.value.splice(W,1,q)}),await M()}catch(v){console.error("读取流错误:",v);break}}catch(u){console.error("发送消息失败:",u),o.content="抱歉，发生了错误，请稍后重试。"}finally{p.value=!1,r.value=[],k.value.value="",await M()}},R=async e=>{y.value=e;try{const t=await B.getChatMessages(e,"chat");l.value=t}catch(t){console.error("加载对话消息失败:",t),l.value=[]}},K=async()=>{try{const e=await B.getChatHistory("chat");g.value=e||[],e&&e.length>0?await R(e[0].id):F()}catch(e){console.error("加载聊天历史失败:",e),g.value=[],F()}},F=()=>{const e=Date.now().toString();y.value=e,l.value=[];const t={id:e,title:`对话 ${e.slice(-6)}`};g.value=[t,...g.value]},O=e=>e<1024?e+" B":e<1024*1024?(e/1024).toFixed(1)+" KB":(e/(1024*1024)).toFixed(1)+" MB",P=e=>{r.value=r.value.filter((t,a)=>a!==e),r.value.length===0&&(k.value.value="")};return G(()=>{K(),T()}),(e,t)=>(n(),i("div",{class:j(["ai-chat",{dark:h(_)}])},[s("div",de,[s("div",ve,[s("div",he,[t[2]||(t[2]=s("h2",null,"聊天记录",-1)),s("button",{class:"new-chat",onClick:F},[f(h(ne),{class:"icon"}),t[1]||(t[1]=J(" 新对话 "))])]),s("div",me,[(n(!0),i($,null,z(g.value,a=>(n(),i("div",{key:a.id,class:j(["history-item",{active:y.value===a.id}]),onClick:o=>R(a.id)},[f(h(ie),{class:"icon"}),s("span",fe,b(a.title||"新对话"),1)],10,pe))),128))])]),s("div",ge,[s("div",{class:"messages",ref_key:"messagesRef",ref:w},[(n(!0),i($,null,z(l.value,(a,o)=>(n(),ae(oe,{key:o,message:a,"is-stream":p.value&&o===l.value.length-1},null,8,["message","is-stream"]))),128))],512),s("div",_e,[r.value.length>0?(n(),i("div",we,[(n(!0),i($,null,z(r.value,(a,o)=>(n(),i("div",{key:o,class:"file-item"},[s("div",ye,[f(h(le),{class:"icon"}),s("span",ke,b(a.name),1),s("span",xe,"("+b(O(a.size))+")",1)]),s("button",{class:"remove-btn",onClick:u=>P(o)},[f(h(ue),{class:"icon"})],8,Ce)]))),128))])):Q("",!0),s("div",Me,[s("div",De,[s("input",{type:"file",ref_key:"fileInput",ref:k,onChange:V,accept:"image/*,audio/*,video/*",multiple:"",class:"hidden"},null,544),s("button",{class:"upload-btn",onClick:U,disabled:p.value},[f(h(ce),{class:"icon"})],8,Fe)]),X(s("textarea",{"onUpdate:modelValue":t[0]||(t[0]=a=>m.value=a),onKeydown:ee(te(L,["prevent"]),["enter"]),placeholder:N(),rows:"1",ref_key:"inputRef",ref:S},null,40,Ie),[[Y,m.value]]),s("button",{class:"send-button",onClick:L,disabled:p.value||!m.value.trim()&&!r.value.length},[f(h(se),{class:"icon"})],8,$e)])])])])],2))}},Re=re(ze,[["__scopeId","data-v-10c377e8"]]);export{Re as default};
